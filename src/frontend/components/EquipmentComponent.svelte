<style>
  div :global(.autocomplete *) {
    width: 25vw;
    max-width: 100%;
  }
</style>

<script lang="ts">
  //@ts-ignore
  import { Box, Button, Grid, Input, NumberInput, SimpleGrid, Text, TextInput, theme } from "@svelteuidev/core";
  import { buildEquipment, buildItem, type Equipment, type Gear } from "../Classes";
  import { AsyncFuzzyTextSearch } from "../generated/graphql";
  //@ts-ignore
  import Select from "svelte-select";
  import { gearList } from "../stores/Store";
  import { onMount } from "svelte/internal";

  export let gear: Gear;
  export let index = 0;
  let searchString = "";
  // let items: any[] = []
  $: reformed = $gearList[index];

  onMount(() => {
    searchString = "Galaxy";
  });

  const asyncTest = async () => {
    const response = await AsyncFuzzyTextSearch({ variables: { fuzzySearch: gear.model } });
    return response.data.fuzzyTextSearch;
  };

  const addItem = () => {
    gear.items = [...gear.items, buildItem()];
  };

  //handle total item count
  const handleItemChange = () => {
    const sum = reformed.items.map((item) => item.itemQuantity);
    reformed.quantity = sum.reduce((partial, i) => partial + i, 0);
    console.log(`Total Items: ${reformed.quantity}`);
  };

  const handleCreateGear = (newGear: Equipment) => {
    let createEquip = buildEquipment();
    return ($gearList[index] = createEquip);
  };

  const handleSelect = (e: { detail: Gear }) => {
    console.log(e.detail);
    gear = e.detail;
    $gearList[index] = gear;
  };
</script>

<Box css="{{ backgroundColor: theme.colors['dark100'] }}">
  <Grid cols="{12}" grow>
    <Grid.Col span="{3}">
      <Text weight="bold" size="xl" m="xs">Quick Search Model</Text>
      <div>
        <Select
          value="{null}"
          loadOptions="{asyncTest}"
          placeholder=""
          on:select="{handleSelect}"
          labelIdentifier="{'model'}"
        />
      </div>
      <Input bind:value="{gear.model}" />
    </Grid.Col>
    <Grid.Col span="{1}">
      <Text weight="bold" size="xl" m="xs">Total Quantity</Text>
      <!-- <NumberInput defaultValue="{gear.items.length}" bind:value="{reformed.quantity}" min="{0}" size="sm" hideControls /> -->
    </Grid.Col>
    <Grid.Col span="{1}">
      <Text weight="bold" size="xl" m="xs">Initial Cost</Text>
      <!-- <NumberInput bind:value="{gear.cost}" min="{0}" size="sm" /> -->
    </Grid.Col>
    <Grid.Col span="{2}">
      <!-- <Text weight="bold" size="xl" m="xs">Total Cost: ${totalCost}</Text> -->
    </Grid.Col>
    <Grid.Col span="{2}">
      <!-- <Text weight="bold" size="xl" m="xs">Total Power Draw: {totalPower}</Text> -->
    </Grid.Col>
    <Grid.Col offset="{1}" span="{1}">
      <!-- <Button on:click="{addItem}" disabled="{!gear.model}">Add Item</Button> -->
    </Grid.Col>
    <!-- {#if reformed.items != undefined && reformed.items.length > 0}
      {#each reformed.items as { description, itemQuantity, publicNotes, privateNotes }}
        <SimpleGrid cols={4} ml="lg" mb="lg">
          <TextInput label="Description" bind:value="{description}" />
          <NumberInput label="Quantity" min="{0}" on:change="{handleItemChange}" bind:value="{itemQuantity}" />
          <TextInput label="Public Notes" bind:value="{publicNotes}" />
          <TextInput label="Private Notes" bind:value="{privateNotes}" />
        </SimpleGrid>  
      {/each}
    {/if} -->
  </Grid>
</Box>
